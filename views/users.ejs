<!DOCTYPE html>
<html>

<head>
  <% include ./partials/header %>
</head>

<body class="nav-md">

  <div class="container body">
    <div class="main_container">
      
      <% include ./partials/side-nav %>
      <% include ./partials/top-nav %>
      <% include ./partials/flash %>

      <!-- page content -->
      <div class="right_col" role="main" style="min-height: 1704px;">

        <!-- Super Admin Abilities START -->
        <%if(user.role == 'SuperAdmin'){%>
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#new-user-modal">
            <i class="fa fa-user-plus"></i>
            New User
          </button>
          <div id="new-user-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">

                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">Ã—</span>
                  </button>
                  <h4 class="modal-title" id="myModalLabel">Create User</h4>
                </div>
                <div class="modal-body">
                  <form id="newUserForm" action="/users" method="POST" class="form-horizontal form-label-left">

                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="email">Email<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="email" type="text" id="email" required="required" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="password">Password<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="password" type="password" id="password" required="required" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="passwordConfirm">Password Confirm<span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <input name="passwordConfirm" type="password" id="passwordConfirm" required="required" class="form-control col-md-7 col-xs-12">
                        </div>
                      </div>
                      <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">Role</label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <select name="role" class="form-control">
                            <option value="SuperAdmin">Super Admin</option>
                            <option selected value="Admin">Admin</option>
                          </select>
                        </div>
                      </div>

                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                  <button type="button" onClick="$('#newUserForm').submit();" class="btn btn-primary">Create!</button>
                </div>

              </div>
            </div>
          </div>
        <%}%>
        <!-- Super Admin Abilities END -->
        
        <div class="row">
          <div class="col-md-12 col-sm-12 col-xs12">
            <div class="x_panel">
              <div class="x_title">
                <h2>Users</h2>
                <ul class="nav navbar-right panel_toolbox">
                  <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                  </li>
                  <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                    <ul class="dropdown-menu" role="menu">
                      <li><a href="#">Settings 1</a>
                      </li>
                      <li><a href="#">Settings 2</a>
                      </li>
                    </ul>
                  </li>
                  <li><a class="close-link"><i class="fa fa-close"></i></a>
                  </li>
                </ul>
                <div class="clearfix"></div>
              </div>
              <div class="x_content">

                  <table id="datatable-users" class="table table-striped table-bordered dataTable no-footer" role="grid">
                    <thead>
                      <tr>
                          <th class="sorting_asc" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 100%;">ID</th>
                          <th class="sorting_asc" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 100%;">Role</th>
                          <th class="sorting_asc" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 100%;">Email</th>
                          <th class="sorting_asc" tabindex="0" aria-controls="datatable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Name: activate to sort column descending" style="width: 170px;">Actions</th>
                      </tr>
                    </thead>
                  </table>

              </div>
            </div>
          </div>
        </div>
        
      </div>
      <!-- /page content -->

      <% include ./partials/footer %>

    </div>
  </div>

  <% include ./partials/scripts %>

  <!-- <script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/rowreorder/1.2.5/js/dataTables.rowReorder.min.js"></script> -->

  <script>
    var $datatableUsers = $('#datatable-users').DataTable({
      "ajax": "/api/users",
      "deferRender": true,
      "columns": [
        {data:"_id"},
        {data:"role"},
        {data:"email"},
        {render: function(a,b,data){
          var wrapstart = '<div style="width:100%;height:100%;text-align:center;">';
          var del = '<button id="delete_'+data._id+'" data-id="'+data._id+'" onclick="userDelete(this)" class="btn btn-danger"><i class="fa fa-trash"></i></button>';
          var edit = '<button id="edit_'+data._id+'" data-id="'+data._id+'" onclick="userEdit(this)" class="btn btn-primary"><i class="fa fa-edit"></i></button>';
          var cancel = '<button id="cancel_'+data._id+'" data-id="'+data._id+'" onclick="editCancel(this)" class="btn btn-primary hidden"><i class="fa fa-close"></i></button>';
          var save = '<button id="save_'+data._id+'" data-id="'+data._id+'" onclick="userSave(this)" class="btn btn-success hidden"><i class="fa fa-save"></i></button>';
          var wrapend = '</div>';
          return wrapstart+edit+cancel+save+del+wrapend;
        }},
      ],
      "dataSrc": 'data',
      "scrollX": true
    });
    function userDelete(el) {
      var $deleteBtn = $(el),
          id = $deleteBtn.data('id');
      if (confirm("Are you sure that you want to delete this user?")) {
        $.ajax({
          url: '/users/'+id,
          method: "DELETE",
          success: function(response){
            if (response.success) {
              feedbackPopup(response.message,'success');
            }
            else {
              feedbackPopup(response.message,'danger');
            }
            $datatableUsers.ajax.reload();
          },
          error: function(response){
            var message = response.statusText+':'+response.status;
            feedbackPopup(message,'danger');
          }
        })
      }
    }
    function userEdit(el) {
      var $editBtn = $(el),
          id = $editBtn.data('id');

      $editBtn.addClass('hidden');
      $('#save_'+id).removeClass('hidden');
      $('#cancel_'+id).removeClass('hidden');
      $('#delete_'+id).addClass('hidden');
    }
    function editCancel(el) {
      var $cancelBtn = $(el),
          id = $cancelBtn.data('id');
      
      if (confirm("Are you sure that you want to cancel your edits?")) {
        $cancelBtn.addClass('hidden');
        $('#save_'+id).addClass('hidden');
        $('#edit_'+id).removeClass('hidden');
        $('#delete_'+id).removeClass('hidden');
      }
    }
    function userSave(el) {
      var $saveBtn = $(el),
          id = $saveBtn.data('id'),
          $cancelBtn = $('#cancel_'+id),
          $saveIcon = $saveBtn.find('i');

      $cancelBtn.addClass('disabled');
      $saveBtn.addClass('disabled');
      $cancelBtn.attr('disabled',true);
      $saveBtn.attr('disabled',true);
      $saveIcon.removeClass('fa-save');
      $saveIcon.addClass('fa-spinner fa-spin');
      setTimeout(function(){
        $saveIcon.removeClass('fa-spinner fa-spin');
        $saveIcon.addClass('fa-check');
        setTimeout(function(){
          $saveBtn.addClass('hidden');
          $cancelBtn.addClass('hidden');
          $saveIcon.removeClass('fa-check');
          $saveIcon.addClass('fa-save');
          $cancelBtn.removeClass('disabled');
          $saveBtn.removeClass('disabled');
          $cancelBtn.attr('disabled',false);
          $saveBtn.attr('disabled',false);
          $('#edit_'+id).removeClass('hidden');
          $('#delete_'+id).removeClass('hidden');
        },500);
      },1500);

    }
  </script>
  
</body>

</html>
